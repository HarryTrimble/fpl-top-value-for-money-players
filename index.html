<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FPL – Top value for money players</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0;
      padding: 1.5rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    h1 { margin: 0 0 0.5rem 0; font-size: 1.6rem; }
    #subtitle { margin-bottom: 0.2rem; font-size: 0.9rem; color: #9ca3af; }
    #last-updated { font-size: 0.85rem; color: #6b7280; margin-bottom: 1rem; }
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    select {
      background: #020617;
      color: #e5e7eb;
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 0.3rem 0.75rem;
      font-size: 0.85rem;
    }
    #status {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 0.5rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    th, td {
      padding: 0.35rem 0.5rem;
      border-bottom: 1px solid #111827;
      white-space: nowrap;
    }
    th {
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 1;
      font-weight: 500;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #9ca3af;
    }

    th:nth-child(1), td:nth-child(1) { text-align: center; }

    /* LEFT-ALIGN: player, position, club */
    th:nth-child(2), td:nth-child(2),
    th:nth-child(4), td:nth-child(4),
    th:nth-child(5), td:nth-child(5) {
      text-align: left;
    }

    td:not(:nth-child(1)):not(:nth-child(2)):not(:nth-child(4)):not(:nth-child(5)) {
      text-align: right;
    }

    tr:nth-child(even) td { background: #020617; }
    tr:hover td { background: #0b1120; }
  </style>
</head>
<body>
  <h1>FPL – Top value for money players</h1>
  <div id="subtitle">Data cached daily – includes last 5 gameweeks.</div>
  <div id="last-updated">Last updated: …</div>

  <div id="controls">
    <label>
      Sort by:
      <select id="sort-select">
        <option value="ptsPerCost">Over the season [total points]</option>
        <option value="formPerCost">Last 30 days [form]</option>
      </select>
    </label>
  </div>

  <div id="status">Loading data…</div>

  <div style="overflow-x: auto;">
    <table id="players-table">
      <thead><tr></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const BOOTSTRAP_URL = "bootstrap-static.json";
    const GW_DIR = "gw";

    const statusEl = document.getElementById("status");
    const lastUpdatedEl = document.getElementById("last-updated");
    const theadRow = document.querySelector("#players-table thead tr");
    const tbody = document.querySelector("#players-table tbody");
    const sortSelect = document.getElementById("sort-select");

    let players = [];
    let currentSortKey = "ptsPerCost";
    let gwHeaders = [];
    let gwInDisplayOrder = [];

    async function init() {
      try {
        const res = await fetch(BOOTSTRAP_URL);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const bootstrap = await res.json();

        /* --- LAST UPDATED TIMESTAMP --- */
        if (bootstrap.last_updated) {
          const date = new Date(bootstrap.last_updated);
          lastUpdatedEl.textContent =
            "Last updated: " +
            date.toLocaleString("en-GB", {
              day: "2-digit",
              month: "short",
              year: "numeric",
              hour: "2-digit",
              minute: "2-digit",
              timeZone: "UTC"
            }) +
            " (UTC)";
        } else {
          lastUpdatedEl.textContent = "Last updated: unknown";
        }

        const finished = bootstrap.events.filter(e => e.finished).sort((a,b) => a.id - b.id);
        const lastFive = finished.slice(-5);

        gwInDisplayOrder = lastFive.slice().reverse();
        gwHeaders = gwInDisplayOrder.map(ev => "GW" + ev.id + " pts");

        const gwMaps = await loadGwLive(lastFive);
        players = transformData(bootstrap, gwInDisplayOrder, gwMaps);

        sortAndRender();
      } catch (err) {
        statusEl.textContent = "Failed to load FPL data: " + err.message;
      }
    }

    async function loadGwLive(lastFive) {
      const result = {};
      await Promise.all(lastFive.map(async ev => {
        try {
          const url = `${GW_DIR}/gw-${ev.id}.json`;
          const res = await fetch(url);
          if (!res.ok) return;
          const data = await res.json();
          const map = {};
          data.elements.forEach(el => {
            map[el.id] = el.stats?.total_points || 0;
          });
          result[ev.id] = map;
        } catch {}
      }));
      return result;
    }

    function transformData(bootstrap, gwDisplayOrder, gwMaps) {
      const teams = {};
      bootstrap.teams.forEach(t => teams[t.id] = t.name);
      const positions = {};
      bootstrap.element_types.forEach(p => positions[p.id] = p.singular_name_short);

      return bootstrap.elements.map(e => {
        const cost = e.now_cost / 10;
        const form = parseFloat(e.form) || 0;
        const totalPoints = e.total_points;
        const ptsPerCost = totalPoints / cost;
        const formPerCost = form / cost;

        const gwPoints = gwDisplayOrder.map(ev =>
          (gwMaps[ev.id] || {})[e.id] || 0
        );

        return {
          name: e.web_name,
          position: positions[e.element_type],
          club: teams[e.team],
          cost,
          form,
          totalPoints,
          ptsPerCost,
          formPerCost,
          gwPoints
        };
      });
    }

    function sortAndRender() {
      const sorted = players.slice().sort((a,b) => b[currentSortKey] - a[currentSortKey]);
      renderTable(sorted);
    }

    function renderTable(list) {
      tbody.innerHTML = "";

      const hidePtsPerCost = currentSortKey === "formPerCost";
      const hideFormPerCost = currentSortKey === "ptsPerCost";

      theadRow.innerHTML = "";
      const headers = ["#", "player"];

      if (!hidePtsPerCost) headers.push("points per £1m (total points ÷ cost)");
      if (!hideFormPerCost) headers.push("points per £1m (form ÷ cost)");

      headers.push("position", "club", "cost", "form", "total points");
      headers.push(...gwHeaders);

      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        theadRow.appendChild(th);
      });

      list.forEach((p, index) => {
        const tr = document.createElement("tr");
        function cell(v) { const td = document.createElement("td"); td.textContent = v; return td; }

        tr.appendChild(cell(index + 1));
        tr.appendChild(cell(p.name));

        if (!hidePtsPerCost) tr.appendChild(cell(p.ptsPerCost.toFixed(2)));
        if (!hideFormPerCost) tr.appendChild(cell(p.formPerCost.toFixed(2)));

        tr.appendChild(cell(p.position));
        tr.appendChild(cell(p.club));
        tr.appendChild(cell(p.cost.toFixed(1)));
        tr.appendChild(cell(p.form.toFixed(1)));
        tr.appendChild(cell(p.totalPoints));

        p.gwPoints.forEach(pts => tr.appendChild(cell(pts)));

        tbody.appendChild(tr);
      });
    }

    sortSelect.addEventListener("change", () => {
      currentSortKey = sortSelect.value;
      sortAndRender();
    });

    init();
  </script>
</body>
</html>
