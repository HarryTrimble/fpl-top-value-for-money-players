<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FPL – Top value for money players</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0;
      padding: 1.5rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    h1 { margin: 0 0 0.5rem 0; font-size: 1.6rem; }
    #subtitle { margin-bottom: 0.2rem; font-size: 0.9rem; color: #9ca3af; }
    #last-updated { font-size: 0.85rem; color: #6b7280; margin-bottom: 1rem; }

    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    select {
      background: #020617;
      color: #e5e7eb;
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 0.3rem 0.75rem;
      font-size: 0.85rem;
    }
    #status {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 0.5rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    th, td {
      padding: 0.35rem 0.5rem;
      border-bottom: 1px solid #111827;
      white-space: nowrap;
      text-align: right; /* default */
    }
    th {
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 1;
      font-weight: 500;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #9ca3af;
    }

    /* Left-align these logical columns */
    th.col-index, td.col-index,
    th.col-player, td.col-player,
    th.col-position, td.col-position,
    th.col-club, td.col-club {
      text-align: left;
    }

    tr:nth-child(even) td { background: #020617; }
    tr:hover td { background: #0b1120; }

    @media (max-width: 900px) {
      table { font-size: 0.75rem; }
      th, td { padding: 0.25rem 0.35rem; }
    }

    /* Tablet: hide the two oldest GW columns (index 3 & 4 of the 5) */
    @media (max-width: 768px) {
      .col-gw-3, .col-gw-4 {
        display: none;
      }
    }

    /* Phone: hide position, cost, form, and all but latest GW */
    @media (max-width: 600px) {
      .col-position,
      .col-cost,
      .col-form {
        display: none;
      }
      .col-gw-1,
      .col-gw-2,
      .col-gw-3,
      .col-gw-4 {
        display: none;
      }
    }
  </style>
</head>

<body>
  <h1>FPL – Top value for money players</h1>
  <div id="subtitle">Data cached daily – includes last 5 gameweeks.</div>
  <div id="last-updated">Last updated: …</div>

  <div id="controls">
    <label>
      Sort by:
      <select id="sort-select">
        <option value="ptsPerCost">Over the season [total points]</option>
        <option value="formPerCost">Last 30 days [form]</option>
      </select>
    </label>
  </div>

  <div id="status">Loading data…</div>

  <div style="overflow-x: auto;">
    <table id="players-table">
      <thead><tr></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const BOOTSTRAP_URL = "bootstrap-static.json";
    const GW_DIR = "gw";

    const statusEl = document.getElementById("status");
    const lastUpdatedEl = document.getElementById("last-updated");
    const theadRow = document.querySelector("#players-table thead tr");
    const tbody = document.querySelector("#players-table tbody");
    const sortSelect = document.getElementById("sort-select");

    let players = [];
    let currentSortKey = "ptsPerCost";
    let gwHeaders = [];
    let gwInDisplayOrder = [];

    async function init() {
      try {
        const res = await fetch(BOOTSTRAP_URL);
        if (!res.ok) throw new Error("HTTP " + res.status);

        // Last updated from HTTP header
        const lastMod = res.headers.get("last-modified");
        if (lastMod) {
          const date = new Date(lastMod);
          lastUpdatedEl.textContent =
            "Last updated: " +
            date.toLocaleString("en-GB", {
              day: "2-digit",
              month: "short",
              year: "numeric",
              hour: "2-digit",
              minute: "2-digit",
              timeZoneName: "short"
            });
        } else {
          lastUpdatedEl.textContent = "Last updated: unknown";
        }

        const bootstrap = await res.json();

        const finished = bootstrap.events
          .filter(e => e.finished)
          .sort((a, b) => a.id - b.id);
        const lastFive = finished.slice(-5);

        gwInDisplayOrder = lastFive.slice().reverse(); // newest first
        gwHeaders = gwInDisplayOrder.map(ev => "GW" + ev.id + " pts");

        const gwMaps = await loadGwLive(lastFive);
        players = transformData(bootstrap, gwInDisplayOrder, gwMaps);

        sortAndRender();
        statusEl.textContent = "";
      } catch (err) {
        statusEl.textContent = "Failed to load FPL data: " + err.message;
      }
    }

    async function loadGwLive(lastFive) {
      const result = {};
      await Promise.all(
        lastFive.map(async ev => {
          try {
            const url = `${GW_DIR}/gw-${ev.id}.json`;
            const res = await fetch(url);
            if (!res.ok) return;
            const data = await res.json();
            const map = {};
            data.elements.forEach(el => {
              map[el.id] = el.stats?.total_points || 0;
            });
            result[ev.id] = map;
          } catch {}
        })
      );
      return result;
    }

    function transformData(bootstrap, gwDisplayOrder, gwMaps) {
      const teams = {};
      bootstrap.teams.forEach(t => (teams[t.id] = t.name));
      const positions = {};
      bootstrap.element_types.forEach(
        p => (positions[p.id] = p.singular_name_short)
      );

      return bootstrap.elements.map(e => {
        const cost = e.now_cost / 10;
        const form = parseFloat(e.form) || 0;
        const totalPoints = e.total_points;

        const ptsPerCost = totalPoints / cost;
        const formPerCost = form / cost;

        const gwPoints = gwDisplayOrder.map(
          ev => (gwMaps[ev.id] || {})[e.id] || 0
        );

        return {
          name: e.web_name,
          position: positions[e.element_type],
          club: teams[e.team],
          cost,
          form,
          totalPoints,
          ptsPerCost,
          formPerCost,
          gwPoints
        };
      });
    }

    function sortAndRender() {
      const sorted = players.slice().sort(
        (a, b) => b[currentSortKey] - a[currentSortKey]
      );
      renderTable(sorted);
    }

    function renderTable(list) {
      tbody.innerHTML = "";

      const hidePtsPerCost = currentSortKey === "formPerCost";
      const hideFormPerCost = currentSortKey === "ptsPerCost";

      // Build header specs with labels + classes
      theadRow.innerHTML = "";
      const headerSpecs = [];

      headerSpecs.push({ label: "#", cls: "col-index" });
      headerSpecs.push({ label: "player", cls: "col-player" });

      if (!hidePtsPerCost) {
        headerSpecs.push({
          label: "points per £1m (total points ÷ cost)",
          cls: "col-value-total"
        });
      }
      if (!hideFormPerCost) {
        headerSpecs.push({
          label: "points per £1m (form ÷ cost)",
          cls: "col-value-form"
        });
      }

      headerSpecs.push({ label: "position", cls: "col-position" });
      headerSpecs.push({ label: "club", cls: "col-club" });
      headerSpecs.push({ label: "cost", cls: "col-cost" });
      headerSpecs.push({ label: "form", cls: "col-form" });
      headerSpecs.push({ label: "total points", cls: "col-total" });

      gwHeaders.forEach((label, i) => {
        headerSpecs.push({
          label,
          cls: `col-gw col-gw-${i}`
        });
      });

      headerSpecs.forEach(spec => {
        const th = document.createElement("th");
        th.textContent = spec.label;
        th.className = spec.cls;
        theadRow.appendChild(th);
      });

      // Body rows
      list.forEach((p, index) => {
        const tr = document.createElement("tr");
        function cell(value, cls) {
          const td = document.createElement("td");
          td.textContent = value;
          td.className = cls;
          return td;
        }

        tr.appendChild(cell(index + 1, "col-index"));
        tr.appendChild(cell(p.name, "col-player"));

        if (!hidePtsPerCost) {
          tr.appendChild(
            cell(p.ptsPerCost.toFixed(2), "col-value-total")
          );
        }
        if (!hideFormPerCost) {
          tr.appendChild(
            cell(p.formPerCost.toFixed(2), "col-value-form")
          );
        }

        tr.appendChild(cell(p.position, "col-position"));
        tr.appendChild(cell(p.club, "col-club"));
        tr.appendChild(cell(p.cost.toFixed(1), "col-cost"));
        tr.appendChild(cell(p.form.toFixed(1), "col-form"));
        tr.appendChild(cell(p.totalPoints, "col-total"));

        p.gwPoints.forEach((pts, i) => {
          tr.appendChild(
            cell(pts, `col-gw col-gw-${i}`)
          );
        });

        tbody.appendChild(tr);
      });
    }

    sortSelect.addEventListener("change", () => {
      currentSortKey = sortSelect.value;
      sortAndRender();
    });

    init();
  </script>
</body>
</html>
